#!/bin/sh
# Pre-commit hook: Check for credentials/secrets and run security checks

echo "üîí Running pre-commit security checks..."

# 1. Check for common secrets patterns in staged files
echo "[1/4] Checking for potential credentials..."

STAGED_FILES=$(git diff --cached --name-only)
FOUND_SECRETS=0

# Patterns to detect (exclude test fixtures and documentation)
for file in $STAGED_FILES; do
  # Skip security fixture files and documentation
  if echo "$file" | grep -qE "fixtures|README|SECURITY|AUDIT"; then
    continue
  fi
  
  if git show ":$file" 2>/dev/null | grep -E "(private_key|aws_secret_access_key|api_key|PRIVATE_KEY|SECRET_KEY|PASSWORD=)" > /dev/null 2>&1; then
    echo "‚ùå Potential credentials detected in $file"
    FOUND_SECRETS=1
  fi
done

if [ $FOUND_SECRETS -eq 1 ]; then
  echo "‚ùå Pre-commit hook FAILED: Credentials detected"
  exit 1
fi

echo "‚úÖ No credentials detected"

# 2. Run ESLint on staged TypeScript files
echo "[2/4] Running ESLint on staged files..."

STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.[jt]sx\?$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
  npx eslint $STAGED_TS_FILES --max-warnings 0 || {
    echo "‚ùå ESLint failed"
    exit 1
  }
else
  echo "‚ÑπÔ∏è  No JavaScript/TypeScript files to lint"
fi

echo "‚úÖ ESLint checks passed"

# 3. Run TypeScript type check
echo "[3/4] Running TypeScript type check..."

npx tsc --noEmit || {
  echo "‚ùå TypeScript check failed"
  exit 1
}

echo "‚úÖ TypeScript checks passed"

# 4. Verify package.json is valid
echo "[4/4] Validating package.json..."

if git diff --cached --name-only | grep -q 'package.json'; then
  node -e "require('./package.json')" || {
    echo "‚ùå Invalid package.json syntax"
    exit 1
  }
  echo "‚úÖ package.json is valid"
else
  echo "‚ÑπÔ∏è  package.json not modified"
fi

echo "üéâ All pre-commit checks passed!"
exit 0

